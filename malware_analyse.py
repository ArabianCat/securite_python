import yara
import json

# Définir la fonction pour générer un rapport

def generate_report(file_path, matches):
    report = {
        'file': file_path,
        'matches': [match.rule for match in matches]
    }
    with open("report.json", "a") as report_file:
        json.dump(report, report_file)
        report_file.write("\n")

# Demander le chemin du fichier à scanner
print("Quel est le chemin du fichier que vous voulez scanner ?")
path = input()

# Demande la catégorie de scan
choix1 = ''
while choix1 != '1' and choix1 != '2':
    print("Quelle catégorie de scan veux-tu faire ?")
    print("1. Malware")
    print("2. Ransomware")
    choix1 = input()
    if choix1 != '1' and choix1 != '2':
        print("Veuillez rentrer 1 ou 2.")

# Demande le type de scan
choix2 = ''
while choix2 != '1' and choix2 != '2':
    print("Quel type de scan veux-tu faire ?")
    print("1. Simple")
    print("2. Avancée")
    choix2 = input()
    if choix2 != '1' and choix2 != '2':
        print("Veuillez rentrer 1 ou 2.")

if choix1 == '1':
    # Vérification du choix et lancement du scan correspondant
    if choix2 == '1':
        # Compiler et appliquer la règle Simple
        common_rule_m = yara.compile('000_common_rules.yar')
        match_cr = common_rule_m.match(path)
        # Afficher les résultats du scan
        if match_cr:
            print("Les règles Yara ont trouvé des correspondances :")
            for match in match_cr:
                print(f"Règle correspondante : {match.rule}")
            generate_report(path, match_cr)
        else:
            print("Aucune correspondance trouvée.")
    elif choix2 == '2':
        # Compiler et appliquer la règle Avancée
        advanced_rule_m = yara.compile('malware_index.yar')
        match_cr = advanced_rule_m.match(path)
        # Afficher les résultats du scan
        if match_cr:
            print("Les règles Yara ont trouvé des correspondances :")
            for match in match_cr:
                print(f"Règle correspondante : {match.rule}")
            generate_report(path, match_cr)
        else:
            print("Aucune correspondance trouvée.")
elif choix1 == '2':
    # Compiler et appliquer la règle Simple
    common_rule_a = yara.compile('ransomware_index.yar')
    match_cr = common_rule_a.match(path)
    # Afficher les résultats du scan
    if match_cr:
        print("Les règles Yara ont trouvé des correspondances :")
        for match in match_cr:
            print(f"Règle correspondante : {match.rule}")
        generate_report(path, match_cr)
    else:
        print("Aucune correspondance trouvée.")